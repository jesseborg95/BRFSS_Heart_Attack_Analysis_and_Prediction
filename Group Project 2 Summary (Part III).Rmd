---
title: "DATS6101 Group Project 2: Predicting Heart Attacks"
author: "Jonathan Giguere, Jesse Borg, Ese Emuraye, Sarah Gates"
date: "December 8th 2019"
output: 
   html_document: 
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(error = FALSE)
```

```{r basicfcn, include=F}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
```

```{r load-packages, message = FALSE}
# Load the packages using the loadPkg function

loadPkg('ggplot2')
loadPkg('dplyr')
loadPkg('usmap')
loadPkg('viridis')
loadPkg('ResourceSelection')
loadPkg('pROC')
loadPkg('pscl')
loadPkg('caret')
loadPkg('car')
```

## 1. Introduction

Heart attacks in the US is one of the biggest killers, with approximately 600,000 dying from heart attacks in the US each year; which means that 1 in 4 deaths are caused by heart attacks. In total, every year around 735,000 Americans have a heart attack; where 525,000 are a first heart attack and 210,000 happen in people who have already had a heart attack ([CDC](https://www.cdc.gov/heartdisease/facts.htm)). This means that over 80% of heart attacks in the US are fatal. Knowing the warning signs and symptoms of a heart attack can greatly increase thw chance of survival, especially when medical treatment is delivered as soon as these symptoms arise. The leading cause of heart attacks is Coronary Heart Disease; which  is a condition in which the coronary arteries (the major blood vessels that supply the heart with blood) get clogged up with deposits of cholesterol. ([NHS](https://www.nhs.uk/conditions/heart-attack/causes/)). There are many factors which cause Coronary Heart Disease which eventually lead to heart attacks, and since so many people are dying every year from heart attacks, this is a very relevant and important topic to conduct more research on.

For this analysis, the Behavior Risk Factor Surveillance System (BRFSS) data from the 2013 survey was used to carry out an EDA and build models to determine the most important variables when predicting whether someone will have a heart attack or not. This data is collected by the CDC from all 50 states via landline phone and cellular phone, covering a variety of health related topics. Generalizability is limited to those in the population with access to a landline or cell phone as well as to those living in a private residence or college housing. These factors leave out individuals and households who fall outside of these conditions, which means that random sampling is not fully taking place. Sampling bias occurs in the form of non-response, indicated by the NA/null points that exist in the dataset.

Our goal is to analyze factors that we believe may be related to heart attacks. We will not assume causality in the EDA portion of our project. We will spend time in it exploring relationships between these variables. After this, we will build and analyze the effectiveness of building two models as they relate to classifying and possibly predicting the occurence of a heart attack in an individual. We will utilize the decision tree method for classification and logistic regression for prediction. We selected these methods because our data includes both categorical and numeric variables and needed flexible methods to be able to work with both types.

## 2. Description of Data

```{r load-data}
# Load the RData dataset

load("brfss2013.RData")
```

### 2.1 Discussion of Data Sources

The BRFSS 2013 Survey dataset was obtained from the [CDC](https://www.cdc.gov/), which contained 491775 observations with 330 variables. Upon first inspection of the variables, it was determined that not all of them was needed, and with the use of literature the dataset was narrowed down to 45 variables.

```{r keeps}
# Choose which variables we want to keep

keeps <- c('X_state', 'imonth', 'genhlth', 'menthlth', 'hlthpln1', 'sleptim1', 'bphigh4', 'bpmeds', 'cholchk','toldhi2', 'cvdinfr4', 'cvdcrhd4', 'cvdstrk3', 'asthma3', 'asthnow', 'addepev2', 'chckidny', 'diabete3', 'veteran3', 'marital', 'educa', 'employ1', 'income2', 'weight2', 'sex', 'pregnant', 'diffwalk', 'smoke100', 'smokday2', 'stopsmk2', 'usenow3', 'alcday5', 'avedrnk2', 'drnk3ge5', 'fruit1', 'fvgreen', 'exerany2', 'prediab1', 'qlmentl2', 'qlstres2', 'drvisits', 'ssbsugar', 'cvdasprn', 'scntwrk1','X_ageg5yr')

brfss_reduced <- brfss2013[keeps]
```


```{r rename}
# Rename the variables to be more descriptive

new_names <- c('state', 'month', 'gen_health', 'mental_health', 'health_coverage', 'sleep_time', 'high_bp', 'bp_meds', 'time_since_cholcheck','told_high_chol', 'heart_attack', 'angina', 'stroke', 'asthma', 'has_asthma_now', 'depression', 'kidney_disease', 'diabetes', 'veteran', 'marital_status', 'education_level', 'employment_status', 'income', 'weight', 'sex', 'pregnant', 'difficulty_walk', 'smoke_100', 'freq_smoke', 'stop_smoke_year', 'smokeless_tabac', 'alc_past_30', 'alc_perday_30', 'binge_alc', 'fruit_freq', 'green_veg_freq', 'exercise_30', 'prediabetes', 'depressed_30', 'anxious_30', 'dr_visits_year', 'soda_freq', 'aspirin_daily', 'work_hours_week','age5yr_bucket')

names(brfss_reduced) <- new_names
```

### 2.2 Cleaning the Data

As with most raw datasets, it is imperative to perform some cleaning operations to remove invalid data.

#### 2.2.1 Removing Null Values

Our first step in cleaning the data is to identify null values. The image below displays the count of null values in each category of the remaining variables in the BRFSS dataset. The fields with more than 100,000 null values were removed, which in this case were: 'dr_visits_year', 'prediabetes', 'binge_alc', 'alc_perday_30', 'freq_smoke', 'bp_meds', 'aspirin_daily', 'soda_freq', 'pregnant', 'stop_smoke_year', 'has_asthma_now', 'work_hours_week', 'depressed_30' and 'anxious_30'. 

```{r check for NAs, include=F}
# Use the is.na function and sort each column by missing values in ascending order

missing_vals <- colSums(is.na(brfss_reduced))
sort(missing_vals)
```

```{r check NA, echo = F, include = T}

# review how many fields are NA
par(mar = c(10, 6, 3, 0.5), mgp = c(5, 0.5, 0))
barplot(colSums(is.na(brfss_reduced)),
  col = "lightblue",
  main = "BRFSS NA Values",
  ylab = "Count of Null Values",
  xlab = "",
  las = 2,
  cex.names = 0.7)

title(xlab="Variable", line=7, cex.lab=1.2)
```

```{r}
# Drop the variables which have too many missing values
brfss_reduced_drops <- subset(brfss_reduced, select = -c(dr_visits_year, prediabetes, binge_alc, alc_perday_30, freq_smoke, bp_meds, aspirin_daily, soda_freq, pregnant, stop_smoke_year, has_asthma_now, work_hours_week, depressed_30, anxious_30))

# Remove the rows which have na values in any of the remaining variables
brfss_complete <- na.omit(brfss_reduced_drops)
```

After the variables with too many NA values were dropped, there are 31 variables left. Their descriptions can be found below:

* **state** - State Fips Code
* **month** - File Month
* **gen_health** - General Health
* **mental_health** - Mental Health
* **health_coverage** - Health Coverage
* **sleep_time** - How Much Do You Sleep
* **high_bp** - Ever Told High Blood Pressure
* **time_since_cholcheck** - Time Since Last Cholesterol Check
* **told_high_chol** - Ever Told High Cholesterol
* **heart_attack** - Ever Had a Heart Attack
* **angina** - Ever Diagnosed With Angina Or Coronary Heart Disease
* **stroke** - Ever Diagnosed With A Stroke
* **asthma** - Ever Diagnosed With Asthma
* **depression** - Ever Told You Had A Depressive Disorder
* **kidney_disease** - Ever Told You Have Kidney Disease
* **diabetes** - Ever Told You Have Diabetes
* **veteran** - Are You A Veteran
* **marital_status** - Marital Status
* **education_level** - Education Level
* **employment_status** - Employment Status
* **income** - Annual Income
* **weight** - How Much Do You Weigh
* **sex** - What Is Your Gender/Sex
* **difficulty_walk** -  Do You Have Difficulty Walking?
* **smoke_100** - Smoked At Least 100 Cigarettes
* **smokeless_tabac** -  Use Of Smokeless Tobacco Products
* **alc_past_30** - Number of Alcoholic Drinks In Past Year
* **fruit_freq** - Number Of Days Consumed Fruit In Past Year
* **green_veg_freq** - Number of Days Consumed Green Vegetables In Past Year
* **exercise_30** - Exercised In The Past 30 Days
* **age5yr_bucket** - Year Group (5 Year Intervals)

<br></br>

#### 2.2.2 Clean up Variables for Analysis

Next, to clean the data we will change the factors for the different variables which we find appropriate. For some variables, the factors were different responses, and since there can be a number of different responses we reduced the different options by changing the responses slightly and assigning the new factors. For most of the variables however, the factors were changed from a 'Yes' or 'No' response to 1 (Yes) or 0 (No). This will make the data easier to work with and allow the models to give better results. Once this was completed, the dataset was saved as a new dataset, which is the cleaned up version. This cleaned dataset will be used for the rest of the analysis. After the cleaning was completed, we moved on to the EDA analysis of the variables which we found were more important for this analysis.

```{r load.data}
# Load the Cleaned RData dataset
load("brfss_complete.RData")
```

## 3. EDA Analysis

This part will be the EDA of our analysis, which will help visualize the data better and help draw some early conclusions. This will serve as a good base for when the model analysis is carried out.

### 3.1 SMART Question: Which States Had The Most Participants, and Which States Had The Highest Percentage of Heart Attacks?

To visualize which states have the most participants and the highest percentage of heart attacks by participants, heatmaps will be plotted to help visualize the spread of participants and heart attacks within the US.

```{r states and participants data}
#Make dataframe showing number of survey particpants by state
participants_map_df <-  brfss_complete %>% group_by(state) %>% summarise(n = n())
participants_map_df <- participants_map_df[-c(52, 53), ]
```

```{r states and respondents}
#Visualize map of number of participants per state
plot_usmap(data = participants_map_df, values = "n", color = "white") + 
  scale_fill_continuous(name = "Survey Participants by State", label = scales::comma) + 
  labs(title = 'Number of Survey Participants per State') +
  theme(legend.position = "right") 
```

```{r states and heart attack data}
#Making dataframe for visualizing heart attacks per state
#Notice that in order to add up the number of heart attacks, i convert the factor to a string and then an integer
state_map_df <- brfss_complete %>% select(state, heart_attack) %>% mutate(state = as.character(state)) %>% group_by(state) %>% summarise(sum_ = sum(as.numeric(as.character(heart_attack)))) %>% filter(state != c('District of Columbia', 'Puerto Rico', 'Guam'))

# Create the percentage of heart attacks to participants
ratios <- (state_map_df$sum_ * 100)/ participants_map_df$n
ratio_df <- data.frame(state_map_df$state, ratios)
names(ratio_df) <- c("state", 'ratio')
```

```{r states and heart map}
#Map showing number of heart attacks per state as a percentage of participants
plot_usmap(data = ratio_df, values = "ratio", color = "white") + 
  scale_fill_continuous(name = "Heart Attack Ratio", label = scales::comma) + 
  labs(title = 'Ratio of Heart Attacks to Participants per State') +
  theme(legend.position = "right")
```

### 3.2 SMART Question: How Do The Number Of Heart Attacks Vary According to Participants' General Health?

```{r heart attacks for different gen_health levels}
#Visualize proportion of respondents with heart attacks by gen_health
ggplot(brfss_complete, aes(x = gen_health, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Heart attack among levels of general health') +
        ylab('Total') +
        xlab('General Health') +
        scale_fill_discrete(name = "Heart Attack?") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### 3.3 SMART Question: How Do The Number of Cholesterol Checks Vary By Age?

```{r}
# Change the responses from 'within past year' to 'recent' if yes and 'not recent' if no 
brfss_complete <- brfss_complete %>%
  mutate(cholchkrecent = ifelse(time_since_cholcheck == "Within past year", "Recent", "Not Recent"))
  
# Create a column for those who responded 'recent',
# Change the responses from 'recent' to 1 if yes and 0 if no
brfss_complete <- brfss_complete %>%
  mutate(cholchkrecent_yes = ifelse(cholchkrecent == "Recent", 1, 0))

# Create a column for those who responded 'not recent'
# Change the responses from 'not recent' to 1 if yes and 0 if no  
brfss_complete <- brfss_complete %>%
  mutate(cholchkrecent_no = ifelse(cholchkrecent == "Not Recent", 1, 0))


# Create a subsetted dataframe to only have those which had a recent cholesterol check,
# then create summart columns  
T_cholchkrecent <- brfss_complete %>%
  filter(told_high_chol != "No", !is.na(time_since_cholcheck), !is.na(age5yr_bucket)) %>%
  group_by(age5yr_bucket) %>% 
  summarise(cholchkratio = sum(cholchkrecent_yes) / sum(cholchkrecent_no), cholchkpercent = sum(cholchkrecent_yes) / (sum(cholchkrecent_no) + sum(cholchkrecent_yes)), cholchkcount = n()) 
# cholchkratio: ratio of cholchkrecent yes to no
# cholchkpercent: percent of cholchkrecent yes over total people with high cholesterol

# Plots
# Plot the ratio of those checked
ggplot(data = T_cholchkrecent, aes(x = age5yr_bucket, y = cholchkratio, color = cholchkratio, size = 1)) +
       geom_point(show.legend = FALSE) +
       ggtitle('Ratio of Cholesterol Checks by 5 Year Age Bucket') +
       ylab('Cholesterol Check Ratio') +
       xlab('Age (5 Year Bucket)') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(angle = 60, hjust = 1, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())


# Plot the percentage of those checked
ggplot(data = T_cholchkrecent, aes(x = age5yr_bucket, y = cholchkpercent, color = cholchkpercent, size = 1)) +
       geom_point(show.legend = FALSE) +
       ggtitle('Percentage of Cholesterol Checks by 5 Year Age Bucket') +
       ylab('Cholesterol Check Percentage') +
       xlab('Age (5 Year Bucket)') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(angle = 60, hjust = 1, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Group by the 5 year buckets and show the ratio, percentages and count 
T_cholchkrecent %>%
  group_by(age5yr_bucket) %>%
  summarise(cholchkratio, cholchkpercent, cholchkcount)
```

### 3.4 SMART Question: How Does The Ratio Of Heart Attacks Vary By Participants' Age and The Time Since Their Last Cholesterol Check?

Graph showing the ratio of heart attacks vary with the participants by their age and the time since their last cholesterol check.  

```{r}
# Visualize the ratio of heart attacks by age and time since last cholesterol check
ggplot(brfss_complete, aes(x=age5yr_bucket, y=time_since_cholcheck, color = heart_attack)) +
  geom_point(size=2) +
  geom_jitter() +
  ggtitle('Ratio of Heart Attacks by Time Since Cholesterol Check and 5 Year Age') +
  ylab('Time Since Cholesterol Check') +
  xlab('Age (5 Year Bucket)') +
  labs(color="Heart Attack?") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, color = 'black')) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### 3.5 SMART Question: How Do The Number Of Heart Attacks Vary Depending On Whether Participants Have Been Diagnosed With Angina?

Graph showing the ratio of heart attacks depending on whether the participants have had an angina or not.

```{r}
# Visualize the ratio of heart attacks to angina
ggplot(brfss_complete, aes(x = angina)) + geom_bar(aes(fill = heart_attack)) +
       ggtitle('Ratio of Heart Attacks if Participant Has Suffered from Angina or Not') +
       ylab('Count') +
       xlab('Suffered Angina?') +
       scale_x_discrete(labels= c('Yes', 'No')) +
       scale_fill_discrete(name = "Heart Attack?") +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(size = 11, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### 3.6 SMART Quesion: How Does Exercise Vary With Age and What Effect Does This Have On Heart Attacks?

Graph showing the number of participants to have exercised within the past 30 days by 5 year age bucket.
  
```{r}
# Visualize if exercised in past 30 days by 5 year age bucket
ggplot(brfss_complete, aes(x = exercise_30, fill = age5yr_bucket)) +
        geom_bar() + 
        ggtitle('Number of participants to have exercised in the past 30 days') +
        ylab('Total') +
        xlab('Exercised in the Past 30 Days?') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
        scale_fill_manual(values=plasma(13), name = "Age Bucket (5 Years)")
```

Graph showing the ratio of heart attacks depending on whether participants have exercised in the past 30 days products or not.
  
```{r}
# Visualize ratio of heart attacks if exercised in past 30 days
ggplot(brfss_complete, aes(x = exercise_30, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Ratio of Heart Attacks if Participant Has Exercised in the Past 30 Days or Not') +
        ylab('Total') +
        xlab('Exercised in the Past 30 Days?') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        scale_fill_discrete(name = "Heart Attack?") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### 3.7 SMART Question: How Does Employment Status Affect The Number of Heart Attacks?

Graph showing the ratio of heart attacks depending on the participants' employment status.

```{r}
# Visualize heart attack ratio to employment
ggplot(brfss_complete, aes(x = employment_status, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of Participants With Heart Attacks by Employment Status ') +
        ylab('Total') +
        xlab('Employment Status') +
        scale_fill_discrete(name = "Heart Attack?") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### 3.8 SMART Question: How Does Annual Income Affect The Number of Heart Attacks?

Graph showing the ratio of heart attacks depending on the participants' annual income.

```{r}
# Visualize heart attack ratio to annual income
ggplot(brfss_complete, aes(x = income, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of Participants With Heart Attacks by Annual Income') +
        ylab('Total') +
        xlab('Annual Income') +
        scale_fill_discrete(name = "Heart Attack?") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

### 3.9 SMART Question: How Does Gender Affect The Number of Heart Attacks?

Graph showing the ratio of heart attacks depending on the participants' gender.

```{r}
# Visualize heart attack ratio to gender
ggplot(brfss_complete, aes(x = sex, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number pf Participants With Heart Attacks by Gender') +
        ylab('Total') +
        xlab('Gender') +
        scale_fill_discrete(name = "Heart Attack?") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### 3.10 SMART Question: How Does Blood Pressure Affect The Number of Heart Attacks?

Graph showing how the porportion of heart attacks vary depending on whether the participants have high blood pressure or not.

```{r heart attacks based on high blood pressure}
#Visualize proportion of respondents with heart attacks by high_bp
ggplot(brfss_complete, aes(x = high_bp, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Heart attacks among people with and without high blood pressure') +
        ylab('Total') +
        xlab('High Blood Pressure?') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        scale_fill_discrete(name = "Heart Attack?") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


