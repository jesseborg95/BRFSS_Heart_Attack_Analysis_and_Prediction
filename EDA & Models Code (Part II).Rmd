---
title: "DATS6101 Group Project: Predicting Heart Attacks - EDA Code"
author: "Jonathan Giguere, Jesse Borg, Ese Emuraye, Sarah Gates"
date: "December 9th 2019"
output:
  html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(error = FALSE)
```

```{r basicfcn, include=F}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
```

## Introduction

For project two, our group used the Behavior Risk Factor Surveillance System (BRFSS) data from the 2013 survey. This data is collected by the CDC from all 50 states via landline phone and cellular phone covering a variety of health related topics. Generalizability is limited to those in the population with access to a landline or cell phone as well as to those living in a private residence or college housing. These factors leave out individuals and households who fall outside of these conditions, which means that random sampling is not fully taking place. Sampling bias occurs in the form of non-response, indicated by the NA/null points that exist in the dataset.

Our goal is to analyze factors that we believe may be related to heart attacks. We will not assume causality in the EDA portion of our project. We will spend time in it exploring relationships between these variables. After this, we will build and analyze the effectiveness of building two models as they relate to classifying and possibly predicting the occurence of a heart attack in an individual. We will utilize the decision tree method for classification and logistic regression for prediction. We selected these methods because our data includes both categorical and numeric variables and needed flexible methods to be able to work with both types.  
  
This file contains the full code we developed for the project and will be used to then write up the summary report.
<br></br>

### Loading the Data

Start by loading the packages we know will be needed for the project. Then load the brfss 2013 data which is as an RData file as opposed to a csv.

```{r load-packages, message = FALSE}
# Load the packages using the loadPkg function

loadPkg('ggplot2')
loadPkg('dplyr')
loadPkg('usmap')
loadPkg('viridis')
loadPkg('ResourceSelection')
loadPkg('pROC')
loadPkg('pscl')
loadPkg('caret')
loadPkg('car')
```

```{r load-data}
# Load the RData dataset

load("brfss2013.RData")
```

## Cleaning the data

We started by choosing the variables which we think will be useful or the most interesting for this study and then renamed them to have more logical or descriptive names.

```{r keeps}
# Choose which variables we want to keep

keeps <- c('X_state', 'imonth', 'genhlth', 'menthlth', 'hlthpln1', 'sleptim1', 'bphigh4', 'bpmeds', 'cholchk','toldhi2', 'cvdinfr4', 'cvdcrhd4', 'cvdstrk3', 'asthma3', 'asthnow', 'addepev2', 'chckidny', 'diabete3', 'veteran3', 'marital', 'educa', 'employ1', 'income2', 'weight2', 'sex', 'pregnant', 'diffwalk', 'smoke100', 'smokday2', 'stopsmk2', 'usenow3', 'alcday5', 'avedrnk2', 'drnk3ge5', 'fruit1', 'fvgreen', 'exerany2', 'prediab1', 'qlmentl2', 'qlstres2', 'drvisits', 'ssbsugar', 'cvdasprn', 'scntwrk1','X_ageg5yr')

brfss_reduced <- brfss2013[keeps]
```


```{r rename}
# Rename the variables to be more descriptive


new_names <- c('state', 'month', 'gen_health', 'mental_health', 'health_coverage', 'sleep_time', 'high_bp', 'bp_meds', 'time_since_cholcheck','told_high_chol', 'heart_attack', 'angina', 'stroke', 'asthma', 'has_asthma_now', 'depression', 'kidney_disease', 'diabetes', 'veteran', 'marital_status', 'education_level', 'employment_status', 'income', 'weight', 'sex', 'pregnant', 'difficulty_walk', 'smoke_100', 'freq_smoke', 'stop_smoke_year', 'smokeless_tabac', 'alc_past_30', 'alc_perday_30', 'binge_alc', 'fruit_freq', 'green_veg_freq', 'exercise_30', 'prediabetes', 'depressed_30', 'anxious_30', 'dr_visits_year', 'soda_freq', 'aspirin_daily', 'work_hours_week','age5yr_bucket')

names(brfss_reduced) <- new_names
```

Once this was done, check to see how many missing values for each column.

```{r check for NAs}
# Use the is.na function and sort each column by missing values in ascending order

missing_vals <- colSums(is.na(brfss_reduced))
sort(missing_vals)
```

Since there are some columns with a lot of missing values, we decided to drop the ones with more than 100,000 missing entries.

```{r}
# Drop the variables which have too many missing values

brfss_reduced_drops <- subset(brfss_reduced, select = -c(dr_visits_year, prediabetes, binge_alc, alc_perday_30, freq_smoke, bp_meds, aspirin_daily, soda_freq, pregnant, stop_smoke_year, has_asthma_now, work_hours_week, depressed_30, anxious_30))
```

We then removed the rows which have any missing values so that the data we have is complete. 

```{r}
# Remove the rows which have na values in any of the remaining variables

brfss_complete <- na.omit(brfss_reduced_drops)
```

Inspect the dataframe after the missing values have been removed, which shows that there are still over 300,000 observations and 31 variables. This is more than enough data for what we need. 

```{r}
# Inspect the dataframe

str(brfss_complete)
```

For the factors, we want to change some of the variable factors to be more intuitive/descriptive, start by inspecting the levels for the factors we might want to change.

```{r}
# Check the levels for some varibles

levels(brfss_complete$high_bp)
levels(brfss_complete$employment_status)
levels(brfss_complete$smokeless_tabac)
levels(brfss_complete$diabetes)
```

Change the yes/no factors to 1/0 for model purposes and change other factors in the variables above to make them better grouped.

```{r}
# Change the factor levels for the variables wwe feel would be better off changed

levels(brfss_complete$health_coverage)[levels(brfss_complete$health_coverage) == 'Yes'] <- 1
levels(brfss_complete$health_coverage)[levels(brfss_complete$health_coverage) == 'No'] <- 0

levels(brfss_complete$heart_attack)[levels(brfss_complete$heart_attack) == 'Yes'] <- 1
levels(brfss_complete$heart_attack)[levels(brfss_complete$heart_attack) == 'No'] <- 0

levels(brfss_complete$angina)[levels(brfss_complete$angina) == 'Yes'] <- 1
levels(brfss_complete$angina)[levels(brfss_complete$angina) == 'No'] <- 0

levels(brfss_complete$stroke)[levels(brfss_complete$stroke) == 'Yes'] <- 1
levels(brfss_complete$stroke)[levels(brfss_complete$stroke) == 'No'] <- 0

levels(brfss_complete$asthma)[levels(brfss_complete$asthma) == 'Yes'] <- 1
levels(brfss_complete$asthma)[levels(brfss_complete$asthma) == 'No'] <- 0

levels(brfss_complete$depression)[levels(brfss_complete$depression) == 'Yes'] <- 1
levels(brfss_complete$depression)[levels(brfss_complete$depression) == 'No'] <- 0

levels(brfss_complete$kidney_disease)[levels(brfss_complete$kidney_disease) == 'Yes'] <- 1
levels(brfss_complete$kidney_disease)[levels(brfss_complete$kidney_disease) == 'No'] <- 0

levels(brfss_complete$veteran)[levels(brfss_complete$veteran) == 'Yes'] <- 1
levels(brfss_complete$veteran)[levels(brfss_complete$veteran) == 'No'] <- 0

levels(brfss_complete$difficulty_walk)[levels(brfss_complete$difficulty_walk) == 'Yes'] <- 1
levels(brfss_complete$difficulty_walk)[levels(brfss_complete$difficulty_walk) == 'No'] <- 0

levels(brfss_complete$smoke_100)[levels(brfss_complete$smoke_100) == 'Yes'] <- 1
levels(brfss_complete$smoke_100)[levels(brfss_complete$smoke_100) == 'No'] <- 0

levels(brfss_complete$told_high_chol)[levels(brfss_complete$told_high_chol) == 'Yes'] <- 1
levels(brfss_complete$told_high_chol)[levels(brfss_complete$told_high_chol) == 'No'] <- 0


levels(brfss_complete$exercise_30)[levels(brfss_complete$exercise_30) == 'Yes'] <- 1
levels(brfss_complete$exercise_30)[levels(brfss_complete$exercise_30) == 'No'] <- 0

levels(brfss_complete$diabetes)[levels(brfss_complete$diabetes) == "Yes, but female told only during pregnancy"] <- 1
levels(brfss_complete$diabetes)[levels(brfss_complete$diabetes) == "No, pre-diabetes or borderline diabetes"  ] <- 0
levels(brfss_complete$diabetes)[levels(brfss_complete$diabetes) == 'Yes'] <- 1
levels(brfss_complete$diabetes)[levels(brfss_complete$diabetes) == 'No'] <- 0

levels(brfss_complete$high_bp)[levels(brfss_complete$high_bp) == "Yes, but female told only during pregnancy"] <- 1
levels(brfss_complete$high_bp)[levels(brfss_complete$high_bp) == "Told borderline or pre-hypertensive" ] <- 1
levels(brfss_complete$high_bp)[levels(brfss_complete$high_bp) == 'Yes'] <- 1
levels(brfss_complete$high_bp)[levels(brfss_complete$high_bp) == 'No'] <- 0

levels(brfss_complete$employment_status)[levels(brfss_complete$employment_status) == "Employed for wages" ] <- 'Employed'
levels(brfss_complete$employment_status)[levels(brfss_complete$employment_status) == "Out of work for 1 year or more" ] <- 'Unemployed'
levels(brfss_complete$employment_status)[levels(brfss_complete$employment_status) == "Out of work for less than 1 year" ] <- 'Unemployed'

levels(brfss_complete$smokeless_tabac)[levels(brfss_complete$smokeless_tabac) == "Every day" ] <- 1
levels(brfss_complete$smokeless_tabac)[levels(brfss_complete$smokeless_tabac) == "Some days" ] <- 1
levels(brfss_complete$smokeless_tabac)[levels(brfss_complete$smokeless_tabac) == "Not at all" ] <- 0

```

Inspect the structure of the dataframe with changed variables

```{r}
# Show the structure of the cleaned data
str(brfss_complete)
```

Save the cleaned file as a New File

```{r}
# Save brfss_complete to a file
save(brfss_complete, file = "brfss_complete.RData")
```

## Exploratory Data Analysis

This part will be the EDA of our analysis, which will help visualize the data better and help draw some early conclusions. This will serve as a good base for when the model analysis is carried out.

<br></br>

Start by looking at the general number of heart attacks in the US and how this changes by state. First the data must be cleaned before it is plotted as a heat map.

```{r states and participants data}
#Make dataframe showing number of survey particpants by state
participants_map_df <-  brfss_complete %>% group_by(state) %>% summarise(n = n())
participants_map_df <- participants_map_df[-c(52, 53), ]
```

```{r states and respondents}
#Visualize map of number of participants per state
plot_usmap(data = participants_map_df, values = "n", color = "white") + 
  scale_fill_continuous(name = "Survey Participants by State", label = scales::comma) + 
  labs(title = 'Number of Survey Participants per State') +
  theme(legend.position = "right") 
```

```{r states and heart attack data}
#Making dataframe for visualizing heart attacks per state
#Notice that in order to add up the number of heart attacks, i convert the factor to a string and then an integer
state_map_df <- brfss_complete %>% select(state, heart_attack) %>% mutate(state = as.character(state)) %>% group_by(state) %>% summarise(sum_ = sum(as.numeric(as.character(heart_attack)))) %>% filter(state != c('District of Columbia', 'Puerto Rico', 'Guam'))

# Create the percentage of heart attacks to participants
ratios <- (state_map_df$sum_ * 100)/ participants_map_df$n
ratio_df <- data.frame(state_map_df$state, ratios)
names(ratio_df) <- c("state", 'ratio')
```

```{r states and heart map}
#Map showing number of heart attacks per state as a percentage of participants

plot_usmap(data = ratio_df, values = "ratio", color = "white") + 
  scale_fill_continuous(name = "Heart Attack Ratio", label = scales::comma) + 
  labs(title = 'Ratio of Heart Attacks to Participants per State') +
  theme(legend.position = "right")
```

Look at how the porportion of heart attacks vary depending on the general health of the participants. 

```{r heart attacks for different gen_health levels}
#Visualize proportion of respondents with heart attacks by gen_health
ggplot(brfss_complete, aes(x = gen_health, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Heart attack among levels of general health') +
        ylab('Total') +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at how the porportion of heart attacks vary depending on whether the participants have health insurance or not.

```{r heart attacks based on health coverage}
#Visualize proportion of respondents with heart attacks by health_coverage
ggplot(brfss_complete, aes(x = health_coverage, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Heart attacks among people with and without health insurance') +
        ylab('Total') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at how the porportion of heart attacks vary depending on whether the participants have high blood pressure or not.

```{r heart attacks based on high blood pressure}
#Visualize proportion of respondents with heart attacks by high_bp
ggplot(brfss_complete, aes(x = high_bp, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Heart attacks among people with and without high blood pressure') +
        ylab('Total') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

To make the visualisation more accurate, the anomalus values for sleep will be removed as it will skew the results and not give true results.

```{r sleep time and heart attack data}
#Filter out extreme sleep numbers to get ready to visualize
sleep_heartattack_df <- brfss_complete %>% select(sleep_time, heart_attack) %>%
   filter(as.integer(sleep_time)<14) %>%  filter(as.integer(sleep_time)>3) 
```

Look at how the porportion of heart attacks vary depending on how many hours the participants sleep on average.

```{r sleep time and heart attack graph}
#Visualize sleep_time and heart_attack
ggplot(sleep_heartattack_df, aes(x = sleep_time, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Heart attacks among levels of sleep') +
        ylab('Total') +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

<br></br>

In exploring cholesterol and time since cholesterol check, we wanted to see if there was a pattern across age for ignoring unpleasant information. The two variables to extrapolate are if someone was told they have high colesterol and the last time they had their cholesterol check. Basically, we wanted to see if once a person is exposed to the negative information of being told they have high cholesterol, is there a pattern in their likeliness to check their cholesterol level morefrequently across age brackets?  
   
<br></br>   
   
First, classify Recent and Not Recent under last cholesterol check as whether the check occurred in the last year or not. Then create a subset of only individuals told that they have high cholesterol.

```{r}
# Change the responses from 'within past year' to 'recent' if yes and 'not recent' if no 
brfss_complete <- brfss_complete %>%
  mutate(cholchkrecent = ifelse(time_since_cholcheck == "Within past year", "Recent", "Not Recent"))
  
# Create a column for those who responded 'recent',
# Change the responses from 'recent' to 1 if yes and 0 if no
brfss_complete <- brfss_complete %>%
  mutate(cholchkrecent_yes = ifelse(cholchkrecent == "Recent", 1, 0))

# Create a column for those who responded 'not recent'
# Change the responses from 'not recent' to 1 if yes and 0 if no  
brfss_complete <- brfss_complete %>%
  mutate(cholchkrecent_no = ifelse(cholchkrecent == "Not Recent", 1, 0))


# Create a subsetted dataframe to only have those which had a recent cholesterol check,
# then create summart columns  
T_cholchkrecent <- brfss_complete %>%
  filter(told_high_chol != "No", !is.na(time_since_cholcheck), !is.na(age5yr_bucket)) %>%
  group_by(age5yr_bucket) %>% 
  summarise(cholchkratio = sum(cholchkrecent_yes) / sum(cholchkrecent_no), cholchkpercent = sum(cholchkrecent_yes) / (sum(cholchkrecent_no) + sum(cholchkrecent_yes)), cholchkcount = n()) 
# cholchkratio: ratio of cholchkrecent yes to no
# cholchkpercent: percent of cholchkrecent yes over total people with high cholesterol

# Plots
# Plot the ratio of those checked
ggplot(data = T_cholchkrecent, aes(x = age5yr_bucket, y = cholchkratio, color = cholchkratio, size = 1)) +
       geom_point(show.legend = FALSE) +
       ggtitle('Ratio of Cholesterol Checks by 5 Year Age Bucket') +
       ylab('Cholesterol Check Ratio') +
       xlab('Age (5 Year Bucket)') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(angle = 60, hjust = 1, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())


# Plot the percentage of those checked
ggplot(data = T_cholchkrecent, aes(x = age5yr_bucket, y = cholchkpercent, color = cholchkpercent, size = 1)) +
       geom_point(show.legend = FALSE) +
       ggtitle('Percentage of Cholesterol Checks by 5 Year Age Bucket') +
       ylab('Cholesterol Check Percentage') +
       xlab('Age (5 Year Bucket)') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(angle = 60, hjust = 1, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Group by the 5 year buckets and show the ratio, percentages and count 
T_cholchkrecent %>%
  group_by(age5yr_bucket) %>%
  summarise(cholchkratio, cholchkpercent, cholchkcount)
```
There appears to be a trend in the relationship between ratio (and percentage) of individuals with high blood pressure getting checked regularly based n age bracket. Relatively younger people tend to not check as frequently even if they have been told they have high cholesterol. The ratio increases steadily until a larger jump after 65, while the percentage increases steadily overall until 70. This could be related to the large jumps in the number of individuals being told that they have high cholesterol as age increases but would require further research. It's interesting to observe the slight decrease in the percentage and ratio of those who have checked recently in the 80 or older bracket.  
  
  
Look at how the ratio of heart attacks vary with the participants by their age and the time since their last cholesterol check.  

```{r}
# Visualize the ratio of heart attacks by age and time since last cholesterol check
ggplot(brfss_complete, aes(x=age5yr_bucket, y=time_since_cholcheck, color = heart_attack)) +
  geom_point(size=2) +
  geom_jitter() +
  ggtitle('Ratio of Heart Attacks by Time Since Cholesterol Check and 5 Year Age') +
  ylab('Time Since Cholesterol Check') +
  xlab('Age (5 Year Bucket)') +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, color = 'black')) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

  
  
Look at the ratio of heart attacks depending on whether the participants have smoked 100 cigarettes

```{r}
# Visualize the ratio of heart attacks if smoked 100 cigs or not
ggplot(brfss_complete, aes(x = smoke_100)) + geom_bar(aes(fill = heart_attack)) +
       ggtitle('Ratio of Heart Attacks if Smoked 100 Cigarettes or Not') +
       ylab('Count') +
       xlab('Smoked 100 Cigarettes?') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(size = 11, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at the ratio of heart attacks depending on whether the participants have had an angina or not.

```{r}
# Visualize the ratio of heart attacks to angina
ggplot(brfss_complete, aes(x = angina)) + geom_bar(aes(fill = heart_attack)) +
       ggtitle('Ratio of Heart Attacks if Participant Has Suffered from Angina or Not') +
       ylab('Count') +
       xlab('Suffered Angina?') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(size = 11, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at the ratio of heart attacks depending on whether the participants have suffered from depression or not.

```{r}
# Visualize the ratio of heart attacks to depression
ggplot(brfss_complete, aes(x = depression)) + geom_bar(aes(fill = heart_attack)) +
       ggtitle('Ratio of Heart Attacks if Participant Has Suffered Depression or Not') +
       ylab('Count') +
       xlab('Suffered From Depression?') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(size = 11, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at the ratio of heart attacks depending on whether the participants have suffered from kidney disease or not.

```{r}
# Visualize the ratio of heart attacks to kidney disease
ggplot(brfss_complete, aes(x = kidney_disease)) + geom_bar(aes(fill = heart_attack)) +
       ggtitle('Ratio of Heart Attacks if Participant Has Suffered Kidney Disease or Not') +
       ylab('Count') +
       xlab('Suffered From Kidney Disease?') +
       theme_bw() +
       theme(plot.title = element_text(hjust = 0.5)) +
       theme(axis.text.x = element_text(size = 11, color = 'black')) +
       theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

<br></br>

We also want to look at whether smoking or using smokeless tobacco has any affect on the rate of heart attacks and see the ratio of participants which smoke or use such smokless tobacco products like chewing tobacco. We also want to look at the effect of alcohol on heart attacks, how fruit and vegetable consumption affect the rate of heart attack and the frequency of exercise. First EDAs will be carried out to see what proprtion of the participants do these different factors and how many of them suffered a heart attack or not.

<br></br>

Look at the ratio of heart attacks depending on whether participants have smoked 100 cigarettes or not.

```{r}
# Visualize the ratio of heart attacks to if smoked 100 cigarettes
ggplot(brfss_complete, aes(x = smoke_100, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of participants to have smoked at least 100 cigarettes') +
        ylab('Total') +
        xlab('Smoked at Least 100 Cigarettes?') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```        
        
Look at the ratio of heart attacks depending on whether participants have used smokeless tobacco products or not.

```{r}
# Visualize the ratio of heart attacks to smokeless tobacco use
ggplot(brfss_complete, aes(x = smokeless_tabac, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of participants to have used smokeless tobacco products') +
        ylab('Total') +
        xlab('') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at the frequency of alcohol consumption among participants, by number of drinks had in 2013

```{r}
# Visualize number of alcoholic drinks in 2013
hist(brfss_complete$alc_past_30,
     main = 'Frequency of alcohol consumption in 2013 among participants',
     xlab = 'Alcohol Consumption',
     col = magma(3),
     breaks=seq(0,250,by=50))
```

Look at the frequency of fruit consumption among participants, by number of days fruit was consumed in 2013

```{r}
# Visualize number of days fruit was consumed
hist(brfss_complete$fruit_freq,
     main = 'Frequency of fruit consumption in 2013 among participants',
     xlab = 'Fruit Consumption',
     col = viridis(7),
     breaks=seq(0,400,by=50))
```

Look at the frequency of green vegetable consumption among participants, by number of days green vegetables were consumed in 2013

```{r}
# Visualize number of days green vegetables were consumed
hist(brfss_complete$green_veg_freq,
     main = 'Frequency of dark green vegetable consumption in 2013 among participants',
     xlab = 'Dark Green Vegetable Consumption',
     col = cividis(3))
```

Look at the number of participants to have exercised within the past 30 days by 5 year age bucket.
  
```{r}
# Visualize if exercised in past 30 days by 5 year age bucket
ggplot(brfss_complete, aes(x = exercise_30, fill = age5yr_bucket)) +
        geom_bar() + 
        ggtitle('Number of participants to have exercised in the past 30 days') +
        ylab('Total') +
        xlab('Exercised in the Past 30 Days?') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
        scale_fill_manual(values=plasma(13))
```

Look at the ratio of heart attacks depending on whether participants have exercised in the past 30 days products or not.
  
```{r}
# Visualize ratio of heart attacks if exercised in past 30 days
ggplot(brfss_complete, aes(x = exercise_30, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Ratio of Heart Attacks if Participant Has Exercised in the Past 30 Days or Not') +
        ylab('Total') +
        xlab('Exercised in the Past 30 Days?') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

<br></br>

Finally for the EDA, look at how diabetes, employment status, income, weight and sex affects heart attack. To do this we will see which ratio of participants have diabetes and which ratio have had heart attacks. We will also look at how employment, income and weight differs with the amount of participants who have suffered heart attacks. Finally we will see if male or female participants suffer more from heart attacks.

<br></br>

Look at the ratio of heart attacks depending on whether or not participants suffer from diabetes.

```{r}
# Visualize heart attack ratio to diabetes
ggplot(brfss_complete, aes(x = diabetes, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of Heart Attacks Among Participants With Diabetes') +
        ylab('Total') +
        scale_x_discrete(labels= c('Yes', 'No')) +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at the ratio of heart attacks depending on the participants' employment status.

```{r}
# Visualize heart attack ratio to employment
ggplot(brfss_complete, aes(x = employment_status, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of Participants With Heart Attacks by Employment Status ') +
        ylab('Total') +
        xlab('Employment Status') +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Look at the ratio of heart attacks depending on the participants' annual income.

```{r}
# Visualize heart attack ratio to annual income
ggplot(brfss_complete, aes(x = income, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number of Participants With Heart Attacks by Annual Income') +
        ylab('Total') +
        xlab('Annual Income') +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 10, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

Look at the weight distribution of the participants.

```{r}
# Convert the weight in pounds to numeric
# The plot the weight distribution as a histogram
brfss_complete$weight = as.numeric(brfss_complete$weight)
hist(brfss_complete$weight,
     main = 'Weight Distribution of Participants',
     xlab = 'Weight (Pounds)',
     col = brfss_complete$heart_attack)
```

Look at the ratio of heart attacks depending on the participants' gender.

```{r}
# Visualize heart attack ratio to gender
ggplot(brfss_complete, aes(x = sex, fill = heart_attack)) +
        geom_bar() + 
        ggtitle('Number pf Participants With Heart Attacks by Gender') +
        ylab('Total') +
        xlab('Gender') +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5)) + 
        theme(axis.text.x = element_text(size = 11, color = 'black')) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

<br></br>

Now that we have carried out EDa analysis on the variables which we will use for the models, it is time to build different models.

<br></br>

## Hypothesis Tests

Before the models are built, some hypothesis testing will be carried out to see which variables are dependent or independent from the heart attacks.

### Chi-Squared Tests of Independence

Start off by carrying out chi-squared test of independence for the different categorical variables.

<br></br>

Chi-Squared Test for General Health And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable1 = table(brfss_complete$gen_health, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest1 = chisq.test(contable1)
chi_p_value1 <- format(chitest1$p.value, scientific = FALSE)
```

Chi-Squared Test for Mental Health And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable2 = table(brfss_complete$mental_health, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest2 = chisq.test(contable2)
chi_p_value2 <- format(chitest2$p.value, scientific = FALSE)
```

Chi-Squared Test for Health Coverage And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable3 = table(brfss_complete$health_coverage, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest3 = chisq.test(contable3)
chi_p_value3 <- format(chitest3$p.value, scientific = FALSE)
```

Chi-Squared Test for High Blood Pressure And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable4 = table(brfss_complete$high_bp, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest4 = chisq.test(contable4)
chi_p_value4 <- format(chitest4$p.value, scientific = FALSE)
```

Chi-Squared Test for Time Since Last Cholesterol Check And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable5 = table(brfss_complete$time_since_cholcheck, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest5 = chisq.test(contable5)
chi_p_value5 <- format(chitest5$p.value, scientific = FALSE)
```

Chi-Squared Test for Told If Cholesterol Was High And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable6 = table(brfss_complete$told_high_chol, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest6 = chisq.test(contable6)
chi_p_value6 <- format(chitest6$p.value, scientific = FALSE)
```

Chi-Squared Test for Angina And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable7 = table(brfss_complete$angina, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest7 = chisq.test(contable7)
chi_p_value7 <- format(chitest7$p.value, scientific = FALSE)
```

Chi-Squared Test for Stroke And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable8 = table(brfss_complete$stroke, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest8 = chisq.test(contable8)
chi_p_value8 <- format(chitest8$p.value, scientific = FALSE)
```

Chi-Squared Test for Asthma And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable9 = table(brfss_complete$asthma, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest9 = chisq.test(contable9)
chi_p_value9 <- format(chitest9$p.value, scientific = FALSE)
```

Chi-Squared Test for Depression And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable10 = table(brfss_complete$depression, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest10 = chisq.test(contable10)
chi_p_value10 <- format(chitest10$p.value, scientific = FALSE)
```

Chi-Squared Test for Kidney Disease And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable11 = table(brfss_complete$kidney_disease, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest11 = chisq.test(contable11)
chi_p_value11 <- format(chitest11$p.value, scientific = FALSE)
```

Chi-Squared Test for Diabetes And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable12 = table(brfss_complete$diabetes, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest12 = chisq.test(contable12)
chi_p_value12 <- format(chitest12$p.value, scientific = FALSE)
```

Chi-Squared Test for Veteran Status And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable13 = table(brfss_complete$veteran, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest13 = chisq.test(contable13)
chi_p_value13 <- format(chitest13$p.value, scientific = FALSE)
```

Chi-Squared Test for Marital Status And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable14 = table(brfss_complete$marital_status, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest14 = chisq.test(contable14)
chi_p_value14 <- format(chitest14$p.value, scientific = FALSE)
```

Chi-Squared Test for Education Level And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable15 = table(brfss_complete$education_level, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest15 = chisq.test(contable15)
chi_p_value15 <- format(chitest15$p.value, scientific = FALSE)
```

Chi-Squared Test for Employment Status And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable16 = table(brfss_complete$employment_status, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest16 = chisq.test(contable16)
chi_p_value16 <- format(chitest16$p.value, scientific = FALSE)
```

Chi-Squared Test for Annual Income And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable17 = table(brfss_complete$income, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest17 = chisq.test(contable17)
chi_p_value17 <- format(chitest17$p.value, scientific = FALSE)
```

Chi-Squared Test for Gender And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable18 = table(brfss_complete$sex, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest18 = chisq.test(contable18)
chi_p_value18 <- format(chitest18$p.value, scientific = FALSE)
```

Chi-Squared Test for Difficulty Walking And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable19 = table(brfss_complete$difficulty_walk, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest19 = chisq.test(contable19)
chi_p_value19 <- format(chitest19$p.value, scientific = FALSE)
```

Chi-Squared Test for Smoked at Least 100 Cigarettes And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable20 = table(brfss_complete$smoke_100, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest20 = chisq.test(contable20)
chi_p_value20 <- format(chitest20$p.value, scientific = FALSE)
```

Chi-Squared Test for Use of Smokeless Tobacco Products And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable21 = table(brfss_complete$smokeless_tabac, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest21 = chisq.test(contable21)
chi_p_value21 <- format(chitest21$p.value, scientific = FALSE)
```

Chi-Squared Test for Exercise in the Past 30 Days And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable22 = table(brfss_complete$exercise_30, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest22 = chisq.test(contable22)
chi_p_value22 <- format(chitest22$p.value, scientific = FALSE)
```

Chi-Squared Test for Age (5 Year Bucket) And Heart Attack

```{r}
#making contingency table for the categorical variable and heart_attack
contable23 = table(brfss_complete$age5yr_bucket, brfss_complete$heart_attack)

#throw contingency table into chitest function and get p-value from test
chitest23 = chisq.test(contable23)
chi_p_value23 <- format(chitest23$p.value, digits = 3)
```

<br></br>

After all of the Chi-Squared Tests of Independence are carried out, create a table to summarise the P-values for each test and also whether to include them in our modelling or not.

<br></br>

Null Hypothesis: The two variables are independent.

Alternative Hypothesis: The two variables are dependent.

<br></br>

Categorical Variable  | Chi-Test P-value < 0.05?     |Include?   | 
----------------------|------------------------------|-----------|
gen_health            | `r chitest1$p.value < 0.05`  | Yes       | 
mental_health         | `r chitest2$p.value < 0.05`  | Yes       |  
health_coverage       | `r chitest3$p.value < 0.05`  | Yes       |  
high_bp               | `r chitest4$p.value < 0.05`  | Yes       |
time_since_cholcheck  | `r chitest5$p.value < 0.05`  | Yes       |
told_high_chol        | `r chitest6$p.value < 0.05`  | Yes       |
angina                | `r chitest7$p.value < 0.05`  | Yes       |
stroke                | `r chitest8$p.value < 0.05`  | Yes       |
ashtma                | `r chitest9$p.value < 0.05`  | Yes       |
depression            | `r chitest10$p.value < 0.05` | Yes       |
kidney_disease        | `r chitest11$p.value < 0.05` | Yes       |
diabetes              | `r chitest12$p.value < 0.05` | Yes       |
veteran               | `r chitest13$p.value < 0.05` | Yes       |
marital_status        | `r chitest14$p.value < 0.05` | Yes       |
education_level       | `r chitest15$p.value < 0.05` | Yes       |
employment_status     | `r chitest16$p.value < 0.05` | Yes       |
income                | `r chitest17$p.value < 0.05` | Yes       |
sex                   | `r chitest18$p.value < 0.05` | Yes       |
difficulty_walk       | `r chitest19$p.value < 0.05` | Yes       |
smoke_100             | `r chitest20$p.value < 0.05` | Yes       |
smokeless_tabac       | `r chitest21$p.value < 0.05` | No        |
exercise_30           | `r chitest22$p.value < 0.05` | Yes       |
age5yr_bucket         | `r chitest23$p.value < 0.05` | Yes       |

Based on the table above, we reject the null hypothesis for all variables except smokeless_tabac.  At a 0.05 threshold, all categorical variables have a dependent relationship with heart_attack except smokeless_tabac.  We will exclude smokeless_tabac in our models.  

## Modeling

After carrying out the Chi-Squared Test of Indepence to determine which categorical variables to use in our models, its time to build the models. Start off by using classification trees.

### Getting Test and Training Sets

Before diving into the creation of our first classification tree, we noticed that the data is imbalanced.  This is a common occurence when working with medical data.  Only 6.1% of the participants had heart attacks in our cleaned up dataset. In order to balance our dataset for training and testing, we identified 19212 people with heart attacks and subset them.  Then, we randomly samples 19212 other participants from the dataframe that contained no heart attacks.  Finally, we put these two dataframes together to get a balanced dataset with a total of 38424 records.  


```{r}
# Create two subsets, one where heart attack occured (1) and one where heart attack didnt occur (0)
brfss_hrtattack <- subset(brfss_complete, heart_attack == '1')
brfss_no_hrtattack <- subset(brfss_complete, heart_attack == '0')

# Create ratios for the number of heart attacks occured and heart attacks didnt occur
ratio1 <- nrow(brfss_hrtattack)/nrow(brfss_complete)
ratio2 <- nrow(brfss_no_hrtattack)/nrow(brfss_complete)

# Set the seen and then take a sample of no heart attacks randomly to balance the data
set.seed(1)
brfss_no_hrtattack <- sample_n(brfss_no_hrtattack, nrow(brfss_hrtattack))

# Display the results
balanced_brfss = rbind(brfss_hrtattack, brfss_no_hrtattack)
nrow(balanced_brfss)
rownames(balanced_brfss) <- NULL
tail(balanced_brfss, 5)
```

Now that we have a balanced dataset, we split the data into training and test sets.  We opted to use 30% of the data for testing and 70% for training.

```{r}
# create test set and training set
set.seed(1)
balanced_hrt_attack_sample <- sample(2, nrow(balanced_brfss), replace=TRUE, prob=c(0.70, 0.30))

# select columns x-y as predictor variables for test/train outputs
bal_hrt_attack_training <- balanced_brfss[balanced_hrt_attack_sample==1, c('heart_attack', 'gen_health', 'mental_health', 'health_coverage', 'sleep_time', 'high_bp', 'time_since_cholcheck', 'angina', 'stroke', 'asthma', 'depression', 'kidney_disease', 'diabetes', 'veteran', 'marital_status', 'education_level', 'employment_status', 'income',  'sex', 'difficulty_walk', 'smoke_100', 'alc_past_30', 'fruit_freq', 'green_veg_freq', 'exercise_30', 'age5yr_bucket')]

bal_hrt_attack_test <- balanced_brfss[balanced_hrt_attack_sample==2, c('heart_attack', 'gen_health', 'mental_health', 'health_coverage', 'sleep_time', 'high_bp', 'time_since_cholcheck', 'angina', 'stroke', 'asthma', 'depression', 'kidney_disease', 'diabetes', 'veteran', 'marital_status', 'education_level', 'employment_status', 'income',  'sex', 'difficulty_walk', 'smoke_100', 'alc_past_30', 'fruit_freq', 'green_veg_freq', 'exercise_30', 'age5yr_bucket')]
```

### Decision Trees

First, we construct a classification tree using all variables as predictors except smokeless_tabac (excluded as a result of chi-square tests), state, and month. We are using our balanced training data for creation of the tree.

```{r}
# Load the tree package
loadPkg('tree')

# Create a tree to predict heart attack using all the variables

heart_attack_fit2 <- tree(heart_attack ~ gen_health + mental_health + health_coverage + sleep_time + high_bp + time_since_cholcheck + angina + stroke + asthma + depression + kidney_disease + diabetes + veteran + marital_status + education_level + employment_status + income + sex + difficulty_walk + smoke_100 + alc_past_30 + fruit_freq + green_veg_freq + exercise_30 + age5yr_bucket, method = 'class', data = bal_hrt_attack_training)

# Summarize the results
summary(heart_attack_fit2)

# Plot the results
plot(heart_attack_fit2, uniform = TRUE, main="Classification Tree")
text(heart_attack_fit2, use.n = TRUE, all = TRUE, cex=.8)
```

We can see that the variables in order of importance for determining heart attack are: angina, employment_status, and gen_health.  Many of the predictor variables are ignored as part of the tree function because their contributions to the model are very insignificant

After creating the above tree, we want to assess how it classifies our training cases.  To do so, we will create a confusion matrix and assess metrics like accuracy, precision, and recall.

We now look at a confusion matrix to see how well the tree classifies our test cases.  We also have calculated accuracy below.  We can see that our first decision tree classified the test cases with 77.6% accuracy.  

```{r}
# Validate Model using decision trees 
tree.pred = predict(heart_attack_fit2, bal_hrt_attack_test, type = "class")

# Compute the confusion matrix
cmm = table(tree.pred, bal_hrt_attack_test$heart_attack)

# Compute the accuracy from the confusion matrix
accuracy.dec = (cmm[[1]] + cmm[[4]])/sum(cmm)
accuracy.dec

# Compute the sensitivity from confusion matrix
sensitivity.dec = cmm[[1]]/(cmm[[1]] + cmm[[2]])
sensitivity.dec

# Compute the specificity from confusion matrix
specificity.dec = cmm[[4]]/(cmm[[3]] + cmm[[4]])
specificity.dec

# Compute the precision from confusion matrix
precision.dec = cmm[[1]]/(cmm[[1]] + cmm[[3]])
precision.dec

# Compute the recall from confusion matrix
recall.dec = cmm[[1]]/(cmm[[1]] + cmm[[2]])
recall.dec

# Compute the F1 Score from precision and recall
f1score.dec = 2 * ((precision.dec * recall.dec)/(precision.dec + recall.dec))
f1score.dec
```

Next we will perform some cross validation to decide if our tree would benefit from any pruning.

```{r}
# Run the cross validation of the tree, show the number of splits and the errors of each cross validation
cv.heart_attack = cv.tree(heart_attack_fit2, FUN=prune.misclass)
cv.heart_attack$size
cv.heart_attack$dev
```

Based on the cross validation, we can see that the optimal number of splits for the tree are either 5 or 4.  Because of these results, we will keep our original tree with four splits, as pruning the tree would provide no benefit.

Next we attempt to perform bagging.  This involves using all predictor variables to make a whole bunvh of trees.  Using more than one tree will hopefully increase model performance.

```{r}
# Load randomforest package
loadPkg('randomForest')

bag.heart_attack = randomForest(heart_attack~., data=bal_hrt_attack_training, mtry=25, importance= TRUE)
bag.heart_attack
```

We can see that the performance of the bagged tree performed with slightly better accuracy.

```{r}

# Validate bagged tree model
tree.pred_bagged = predict(bag.heart_attack, bal_hrt_attack_test, type = "class")

# Compute confusion matrix
cmm1 = table(tree.pred_bagged, bal_hrt_attack_test$heart_attack)

# Compute the accuracy from confusion matrix
accuracy.bag = (cmm1[[1]] + cmm1[[4]])/sum(cmm1)
accuracy.bag

# Compute the sensitivity from confusion matrix
sensitivity.bag = cmm1[[1]]/(cmm1[[1]] + cmm1[[2]])
sensitivity.bag

# Compute the specificity from confusion matrix
specificity.bag = cmm1[[4]]/(cmm1[[3]] + cmm1[[4]])
specificity.bag

# Compute the precision from confusion matrix
precision.bag = cmm1[[1]]/(cmm1[[1]] + cmm1[[3]])
precision.bag

# Compute the recall from confusion matrix
recall.bag = cmm1[[1]]/(cmm1[[1]] + cmm1[[2]])
recall.bag

# Compute the F1 Score from precision and recall
f1score.bag = 2 * ((precision.bag * recall.bag)/(precision.bag + recall.bag))
f1score.bag
```

Next we will look at random forest and see if we can get even better accuracy.

```{r}
# perform random forest modelling 
randForest.heart_attack = randomForest(heart_attack~., data=bal_hrt_attack_training, mtry=2, importance= TRUE)
randForest.heart_attack
```

The confusion matrix and accuracy for the random forest is given below.

```{r}
# Validate randdom Forest tree model 
tree.pred_randForest = predict(randForest.heart_attack, bal_hrt_attack_test, type = "class")

# Compute confusion matrix
cmm2 = table(tree.pred_randForest, bal_hrt_attack_test$heart_attack)

# Compute accuracy from confusion
accuracy.randT = (cmm2[[1]] + cmm2[[4]])/sum(cmm2)
accuracy.randT

# Compute the sensitivity from confusion matrix
sensitivity.randT = cmm2[[1]]/(cmm2[[1]] + cmm2[[2]])
sensitivity.randT

# Compute the specificity from confusion matrix
specificity.randT = cmm2[[4]]/(cmm2[[3]] + cmm2[[4]])
specificity.randT

# Compute the precision from confusion matrix
precision.randT = cmm2[[1]]/(cmm2[[1]] + cmm2[[3]])
precision.randT

# Compute the recall from confusion matrix
recall.randT = cmm2[[1]]/(cmm2[[1]] + cmm2[[2]])
recall.randT

# Compute the F1 Score from precision and recall
f1score.randT = 2 * ((precision.randT * recall.randT)/(precision.randT + recall.randT))
f1score.randT
```

### Logistic Regression

Key variables identified in trees in order of significance: agina, employment status, gen health, high bp

```{r}
# logistic regression
# run chi squ test between categorical variables
# use forward selection method
heart_attack_logit1 <- glm(heart_attack ~ angina + employment_status + gen_health + high_bp, family="binomial", data = bal_hrt_attack_training)

# all variables
# ( sex + sleep_time + age5yr_bucket+ state + gen_health + mental_health + health_coverage + sleep_time + high_bp + time_since_cholcheck + angina + stroke + asthma + depression + kidney_disease + diabetes + veteran + marital_status + education_level + employment_status + income + weight + sex + difficulty_walk + smoke_100 + alc_past_30 + fruit_freq + green_veg_freq + exercise_30 + age5yr_bucket, family="binomial", data = heart_attack_training)

summary(heart_attack_logit1)
```
  
Growth/decay factors for each explanatory variable (calculated as exponentials of the model coefficients):

```{r growthDecayFactors, results='markup', collapse=F}
# Calculate the exponentials
exp(coef(heart_attack_logit1))
```
  
Confidence intervals of each coefficient of the model:

```{r ConfInt, results='markup', collapse=F}
# CIs using standard errors
confint.default(heart_attack_logit1)
```
  
Hosmer and Lemeshow Goodness of Fit:

```{r HosmerLemeshow}
# Carry out Hosmer & Lemeshow GOF
heart_attackLogitHoslem = hoslem.test(bal_hrt_attack_training$heart_attack, fitted(heart_attack_logit1))
heart_attackLogitHoslem
```
  
According to the Hosmer and Lemeshow Goodness of Fit test using the training dataset, the p value is `r heart_attackLogitHoslem$p.value`. This is very small so it means that this model is a good fit. Although this test is not very meaningful for models with only factors, it continues to support the other analysis. 

McFadden test:

```{r McFadden}
# Carry out the McFadden Test
heart_attack_logit1_pr2 = pR2(heart_attack_logit1)
heart_attack_logit1_pr2
```

The McFadden value of this model is `r heart_attack_logit1_pr2['McFadden']`, which means that about 35% of the variations in y is explained by the variables in the model.  
  
ROC & AUC analysis:  
Use training and test datasets to evaluate the area under the curve (AUC) for each.  
  
Training:

```{r roc_auc}
# Carry out the probability calculation for the training set
# prob = predict(heart_attack_logit1, bal_hrt_attack_training, type = "response")
prob = plogis(predict(heart_attack_logit1, bal_hrt_attack_training))
bal_hrt_attack_training$prob=prob

# Create the roc and then calculate and plot the area under the curve
h <- roc(heart_attack~prob, data=bal_hrt_attack_training)
auc(h) # area-under-curve (prefer 0.8 or higher)
plot(h)
```

The the area-under-curve is `r auc(h)` for the training data, which is more than 0.8. This outcome agrees with the Hosmer and Lemeshow test that the model is considered a good fit. More importantly, we will now look at the test data.   
  
Test set: 

```{r roc_auc2}
# Carry out the probability calculation for the test set
# prob2 = predict(heart_attack_logit1, bal_hrt_attack_test, type = "response") # use model on test data
prob2 = plogis(predict(heart_attack_logit1, bal_hrt_attack_test))
bal_hrt_attack_test$prob=prob2

# Create the roc and then calculate and plot the area under the curve
j <- roc(heart_attack~prob, data=bal_hrt_attack_test)
auc(j) # area-under-curve (prefer 0.8 or higher)
plot(j)
```

The the area-under-curve is `r auc(j)` which is also above .8, meaning that this is a strong model.  
  
Create confusion matrix from logistic regression output  

```{r cm}

# confusion matrix for test
cmlog = table(bal_hrt_attack_test$heart_attack, prob2 > .5)


# Compute accuracy from confusion
accuracy.logit = (cmlog[[1]] + cmlog[[4]])/sum(cmlog)
accuracy.logit

# Compute the sensitivity from confusion matrix
sensitivity.logit = cmlog[[1]]/(cmlog[[1]] + cmlog[[2]])
sensitivity.logit

# Compute the specificity from confusion matrix
specificity.logit = cmlog[[4]]/(cmlog[[3]] + cmlog[[4]])
specificity.logit

# Compute the precision from confusion matrix
precision.logit = cmlog[[1]]/(cmlog[[1]] + cmlog[[3]])
precision.logit

# Compute the recall from confusion matrix
recall.logit = cmlog[[1]]/(cmlog[[1]] + cmlog[[2]])
recall.logit

# Compute the F1 Score from precision and recall
f1score.logit = 2 * ((precision.logit * recall.logit)/(precision.logit + recall.logit))
f1score.logit
```
  
  
## Model Evaluation   
  
Statistic              | Logistic Regression | Classification Tree | Bagged Tree | Random Forrest |
-----------------------|---------------------|---------------------|-------------|----------------|
Accuracy               | `r accuracy.logit`    | `r accuracy.dec`    |`r accuracy.bag`| `r accuracy.randT`  |
Specificity            | `r specificity.logit` | `r specificity.dec` |`r specificity.bag`           | `r specificity.randT` | 
Sensitivity            | `r sensitivity.logit` | `r sensitivity.dec` |`r sensitivity.bag`           | `r sensitivity.randT` |  
Precision              | `r precision.logit`   | `r precision.dec`   |`r precision.bag`             | `r precision.randT`   |
Recall                 | `r recall.logit`      | `r recall.dec`      |`r recall.bag` | `r recall.randT`                |
F1 Score               | `r f1score.logit`     | `r f1score.dec`     |`r f1score.bag`| `r f1score.randT`               | 
